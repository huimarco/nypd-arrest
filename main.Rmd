---
title: "main"
author: "Marco Hui"
date: "`r Sys.Date()`"
output: html_document
---
## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE)
```

```{r libraries}
library(tidyverse)
library(lubridate)
```

```{r Plot Theme}
# create plot theme
gg_theme <- theme(#plot.title = element_text(face='bold',size=22,vjust=1),
                  axis.title.x = element_blank(),
                  axis.title.y = element_blank(),
                  panel.grid.major.x = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill='grey95'),
                  panel.border = element_blank())
```

```{r data}
# load data from downloaded csv files on local desktop
# note: decided against accessing data via API because that is limited to 500000 rows per call  
arrests <- read_csv('/Users/marcohui/Desktop/NYPD_Arrests_Data__Historic_.csv')
arrests2022 <- read_csv('/Users/marcohui/Desktop/NYPD_Arrest_Data__Year_to_Date_.csv') %>%
  rename(Lon_Lat=`New Georeferenced Column`)

# combine data
arrests <- bind_rows(arrests,arrests2022)

# filter arrests between 2018 and 2021
arrests <- arrests %>% 
  mutate(ARREST_DATE = mdy(ARREST_DATE)) %>% 
  filter(year(ARREST_DATE)>2017)
```

## Exploratory data analysis
```{r}
head(arrests)
```

```{r}
# find number of rows and columns
dim(arrests)
```

```{r}
# get summary statistics
summary(arrests)
```
Fewer arrests towards the end of the year. This might be because less people are out in public during the cold winter months.
```{r}
# plot arrests count per month
arrests %>% 
  group_by(month=factor(month(ARREST_DATE))) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=month,y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Month') +
  gg_theme
```

Fewer arrests in Staten Island and Queens. This might be because of their smaller population.
```{r}
# plot arrests count per borough
arrests %>% 
  group_by(ARREST_BORO) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(ARREST_BORO,-count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Borough') +
  gg_theme
```
```{r}
head(arrests)
```

More arrests involving perpetrators who are 25-44 years old, males, and black.
```{r}
# plot arrests count per age group
arrests %>% 
  group_by(AGE_GROUP) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(AGE_GROUP,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Age Group') +
  coord_flip() +
  gg_theme

# plot arrests count per sex
arrests %>% 
  group_by(PERP_SEX) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(PERP_SEX,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Sex') +
  coord_flip() +
  gg_theme

# plot arrests count per race
arrests %>% 
  group_by(PERP_RACE) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(PERP_RACE,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Race') +
  coord_flip() +
  gg_theme
```

## Has the arrest rate been decreasing from 2018-2022?
```{r}
# plot arrests count per year (difficult for comparisons because 2022 data is incomplete)
arrests %>% 
  group_by(year=year(ARREST_DATE)) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=year,y=count)) + 
  geom_line(colour='blue4') +
  labs(title='Number of Arrests By Year') +
  gg_theme
```

```{r,fig.width=20,fig.height=10}
# plot arrests count per month and year
arrests %>% 
  group_by(yearmonth=substr(ARREST_DATE,0,7)) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=yearmonth,y=count,group=1)) + 
  geom_line(colour='blue4') + 
  geom_smooth(method=loess,se=F,colour='red3',size=0.5,formula=y~x) +
  labs(title='Number of Arrests By Year and Month') +
  gg_theme +
  theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

## What are the top 5 most frequent arrests as described in the column 'pd_desc' in 2018-2022?

```{r}
arrests %>% 
  group_by(OFNS_DESC) %>% 
  summarise(count=n()) %>%
  mutate(pcnt=round(count/sum(count),3)) %>%
  arrange(desc(pcnt))
```

```{r}
arrests %>% head(100)
```
### If we think of arrests as a sample of total crime, is there more crime in precinct 19 (Upper East Side) than precinct 73 (Brownsville)? 
```{r}
arrests %>% 
  group_by(precinct=ARREST_PRECINCT) %>% 
  summarise(count=n()) %>%
  filter(precinct==19|precinct==73)
```

### Given the available data, what model would you build to predict crime to better allocate NYPD resources?

