---
title: "main"
author: "Marco Hui"
date: "`r Sys.Date()`"
output: html_document
---
## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE)
```

```{r libraries}
library(tidyverse)
library(lubridate)
```

```{r Plot Theme}
# create plot theme
gg_theme <- theme(axis.title.x = element_blank(),
                  axis.title.y = element_blank(),
                  panel.grid.major.x = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill='grey95'),
                  panel.border = element_blank())
```

I decided against accessing data via an API endpoint because that is limited to 500000 rows per call
```{r data}
# load data from downloaded csv files on local desktop
arrests <- read_csv('/Users/marcohui/Desktop/NYPD_Arrests_Data__Historic_.csv')
arrests2022 <- read_csv('/Users/marcohui/Desktop/NYPD_Arrest_Data__Year_to_Date_.csv') %>%
  rename(Lon_Lat=`New Georeferenced Column`)

# combine data
arrests <- bind_rows(arrests,arrests2022)

# filter arrests between 2018 and 2021
arrests <- arrests %>% 
  mutate(ARREST_DATE = mdy(ARREST_DATE)) %>% 
  filter(year(ARREST_DATE)>2017)
```


## Exploratory data analysis
```{r}
head(arrests)
```

```{r}
# find number of rows and columns
dim(arrests)
```

```{r}
# get summary statistics
summary(arrests)
```
Fewer arrests towards the end of the year. This might be because less people are out in public during the cold winter months.
```{r}
# plot arrests count per month
arrests %>% 
  group_by(month=factor(month(ARREST_DATE))) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=month,y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Month') +
  gg_theme
```

Fewer arrests in Staten Island and Queens. This might be because of their smaller population.
```{r}
# plot arrests count per borough
arrests %>% 
  group_by(ARREST_BORO) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(ARREST_BORO,-count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Borough') +
  gg_theme
```
```{r}
head(arrests)
```

More arrests involving perpetrators who are 25-44 years old, males, and black.
```{r}
# plot arrests count per age group
arrests %>% 
  group_by(AGE_GROUP) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(AGE_GROUP,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Age Group') +
  coord_flip() +
  gg_theme

# plot arrests count per sex
arrests %>% 
  group_by(PERP_SEX) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(PERP_SEX,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Sex') +
  coord_flip() +
  gg_theme

# plot arrests count per race
arrests %>% 
  group_by(PERP_RACE) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=reorder(PERP_RACE,count),y=count)) + 
  geom_bar(stat='identity',fill='blue4') +
  labs(title='Number of Arrests By Perpetrator Race') +
  coord_flip() +
  gg_theme
```


## Has the arrest rate been decreasing from 2018-2022?
Arrests count demonstrates a downwards trend from 2018 to 2022. However, it is difficult to use the 2022 number for comparison because data is incomplete (records stop at July 2022).  
```{r}
# plot arrests count per year
arrests %>% 
  group_by(year=year(ARREST_DATE)) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=year,y=count)) + 
  geom_line(colour='blue4') +
  labs(title='Number of Arrests By Year') +
  gg_theme
```

Average monthly arrests per year.
```{r}
# average monthly arrests per year
arrests %>% 
  group_by(year=year(ARREST_DATE),month=month(ARREST_DATE)) %>%
  summarise(count=n()) %>%
  ungroup() %>% 
  group_by(year) %>% 
  summarise(avg=sum(count)/max(month))
```

A breakdown of months and year provides a better picture with more nuances and addresses previous limitation of incomplete data.
```{r,fig.width=20,fig.height=10}
# plot arrests count per month and year
arrests %>% 
  group_by(yearmonth=substr(ARREST_DATE,0,7)) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=yearmonth,y=count,group=1)) + 
  geom_line(colour='blue4') + 
  geom_smooth(method=loess,se=F,colour='orange',size=0.5,formula=y~x) +
  labs(title='Number of Arrests By Year and Month') +
  gg_theme +
  theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

Focusing on data prior to the COVID19 pandemic in March 2020, the downward trend of arrests is more evident.
```{r}
# plot arrests count per month and year filtered
arrests %>% 
  filter(ARREST_DATE<'2020-03-01') %>%
  group_by(yearmonth=substr(ARREST_DATE,0,7)) %>% 
  summarise(count=n()) %>%

ggplot(aes(x=yearmonth,y=count,group=1)) + 
  geom_line(colour='blue4') + 
  geom_smooth(method=loess,se=F,colour='orange',size=0.5,formula=y~x) +
  labs(title='Number of Arrests By Year and Month Pre-Pandemic') +
  gg_theme +
  theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

## What are the top 5 most frequent arrests as described in the column 'pd_desc' in 2018-2022?
Many  
```{r}
arrests %>% 
  group_by(OFNS_DESC) %>% 
  summarise(count=n()) %>%
  mutate(pcnt=round(count/sum(count),3)) %>%
  arrange(desc(pcnt))

arrests %>% 
  group_by(PD_DESC) %>% 
  summarise(count=n()) %>%
  mutate(pcnt=round(count/sum(count),3)) %>%
  arrange(desc(pcnt))
```

```{r}
arrests %>% head(100)
```
### If we think of arrests as a sample of total crime, is there more crime in precinct 19 (Upper East Side) than precinct 73 (Brownsville)? 

In total, there are more crime by count in Brownsville than in Upper East Side
```{r}
arrests %>% 
  group_by(ARREST_PRECINCT) %>% 
  summarise(count=n()) %>%
  mutate(pcnt=round(count/sum(count),4)) %>%
  filter(ARREST_PRECINCT==19|ARREST_PRECINCT==73) %>%
  arrange(-count)
```

```{r,fig.width=20,fig.height=10}
arrests %>% 
  filter(ARREST_PRECINCT==19|ARREST_PRECINCT==73) %>%
  group_by(yearmonth=substr(ARREST_DATE,0,7),precinct=factor(ARREST_PRECINCT)) %>% 
  summarise(count=n()) %>%
  
ggplot(aes(x=yearmonth,y=count,colour=precinct,group=precinct)) + 
  geom_line() + 
  geom_smooth(method=loess,se=F,colour='orange',size=0.5,formula=y~x) +
  labs(title='Number of Arrests') +
  gg_theme +
  theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

### Given the available data, what model would you build to predict crime to better allocate NYPD resources?

